<!-- AR.js by @jerome_etienne - github: https://github.com/jeromeetienne/ar.js - info: https://medium.com/arjs/augmented-reality-in-10-lines-of-html-4e193ea9fdbf -->
<html>
    <head>
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        
        <script src="js/three.min.js"></script><style>@media print {#ghostery-purple-box {display:none !important}}</style>

        <script src="js/stats.min.js"></script>
        <!-- ar.js -->
        <script src="js/ar.js"></script>
        <script>THREEx.ArToolkitContext.baseURL = './'</script>
    
        <!--collada loader-->
<!--
		<script src="js/loaders/collada/Animation.js"></script>
		<script src="js/loaders/collada/AnimationHandler.js"></script>
		<script src="js/loaders/collada/KeyFrameAnimation.js"></script>
		<script src="js/loaders/ColladaLoader.js"></script>
-->
        
    </head>
    <body style='margin : 0px; overflow: hidden;'>
        <div style="position: absolute; top: 10px; width:100%; text-align: center; z-index: 1;">
            <a href="https://github.com/jeromeeltienne/AR.js/" target="_blank">AR.js</a> - three.js mobile performance test page.
            <br>
            Please load this page with Chrome browser on Android to start.
        </div>
        
        <script>
	//////////////////////////////////////////////////////////////////////////////////
	//		Init
	//////////////////////////////////////////////////////////////////////////////////
            var clock, mixer, stats, renderer, camera, action, scene;
            var textureLoader, loader;
            
            // init renderer
            renderer = new THREE.WebGLRenderer({
                antialias	: true,
                alpha: true
            });
            
            renderer.setClearColor(new THREE.Color('lightgrey'), 0)
            // renderer.setPixelRatio( 1/2 );
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.domElement.style.position = 'absolute'
            renderer.domElement.style.top = '0px'
            renderer.domElement.style.left = '0px'
            document.body.appendChild( renderer.domElement );

            // init scene
            scene	= new THREE.Scene();
            
            //init animation container
            textureLoader = new THREE.TextureLoader();
            loader = new THREE.JSONLoader();
            
            clock = new THREE.Clock();
	
	//////////////////////////////////////////////////////////////////////////////////
	//		Initialize a basic camera
	//////////////////////////////////////////////////////////////////////////////////

            // Create a camera
            camera = new THREE.Camera();
//            var camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
            scene.add(camera);

	////////////////////////////////////////////////////////////////////////////////
	//          handle arToolkitSource
	////////////////////////////////////////////////////////////////////////////////

            var arToolkitSource = new THREEx.ArToolkitSource({
		    // to read from the webcam 
            sourceType : 'webcam',

            // to read from an image
            // sourceType : 'image',
            // sourceUrl : THREEx.ArToolkitContext.baseURL + '../data/images/img.jpg',		

            // to read from a video
            // sourceType : 'video',
            // sourceUrl : THREEx.ArToolkitContext.baseURL + '../data/videos/headtracking.mp4',
            })

            arToolkitSource.init(function onReady(){
                onResize()
            })

            // handle resize
            window.addEventListener('resize', function(){
                onResize()
            })
            
            function onResize(){
                arToolkitSource.onResize()	
                arToolkitSource.copySizeTo(renderer.domElement)	
                if( arToolkitContext.arController !== null ){
                    arToolkitSource.copySizeTo(arToolkitContext.arController.canvas)	
                }	
            }
	////////////////////////////////////////////////////////////////////////////////
	//          initialize arToolkitContext
	////////////////////////////////////////////////////////////////////////////////
            // create atToolkitContext
            var arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: THREEx.ArToolkitContext.baseURL + './data/ar/camera_para.dat',
                detectionMode: 'mono',
                maxDetectionRate: 30,
                canvasWidth: 80*3,
                canvasHeight: 60*3,
            })
            // initialize it
            arToolkitContext.init(function onCompleted(){
                // copy projection matrix to camera
                camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
            })

            // update artoolkit on every frame
            
//            onRenderFcts.push(function(){
//                if( arToolkitSource.ready === false )	return
//
//                arToolkitContext.update( arToolkitSource.domElement )
//            })
	
	
	////////////////////////////////////////////////////////////////////////////////
	//          Create a ArMarkerControls
	////////////////////////////////////////////////////////////////////////////////
	
            var markerRoot = new THREE.Group
            scene.add(markerRoot)
            var artoolkitMarker = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                type : 'pattern',
//                patternUrl : THREEx.ArToolkitContext.baseURL + './data/data/patt.hiro'
                patternUrl : 'data/ar/apdLogo.patt'
            })

            // build a smoothedControls
            var smoothedRoot = new THREE.Group()
            scene.add(smoothedRoot)
            var smoothedControls = new THREEx.ArSmoothedControls(smoothedRoot, {
                lerpPosition: 0.4,
                lerpQuaternion: 0.3,
                lerpScale: 1,
            })
//            onRenderFcts.push(function(delta){
//                smoothedControls.update(markerRoot)
//            })
	////////////////////////////////////////////////////////////////////////////////
	//		add an object in the scene
	////////////////////////////////////////////////////////////////////////////////

            var arWorldRoot = smoothedRoot

            var ambient = new THREE.AmbientLight(0x888890);
//            scene.add( ambient );
            arWorldRoot.add( ambient );

            var directionalLight = new THREE.DirectionalLight(0x999999);
            directionalLight.position.set( -100, 100, -100 );
//            directionalLight.position.set( 0, 0, 0 ).normalize();
            directionalLight.target.position.set( 0, 0, 0 );
//            scene.add( directionalLight );
            arWorldRoot.add( directionalLight );

            var directionalLight2 = new THREE.DirectionalLight(0x77777777);
            directionalLight2.position.set( -100, -100, -100 );
//            directionalLight.position.set( 0, 0, 0 ).normalize();
            directionalLight2.target.position.set( 0, 0, 0 );
//            scene.add( directionalLight );
            arWorldRoot.add( directionalLight2 );

	////////////////////////////////////////////////////////////////////////////////
	//		add a testbox
	////////////////////////////////////////////////////////////////////////////////
//            var geometry	= new THREE.CubeGeometry(1,1,1);
//            var material	= new THREE.MeshNormalMaterial({
//                transparent : true,
//                opacity: 0.5,
//                side: THREE.DoubleSide
//            }); 
//            var mesh	= new THREE.Mesh( geometry, material );
//            mesh.position.y	= geometry.parameters.height/2
//            	arWorldRoot.add( mesh );
//            mesh.scale.set(0.1,0.1,0.1);
//            scene.add( mesh );
	
    ////////////////////////////////////////////////////////////////////////////////
	//		add a torus
	////////////////////////////////////////////////////////////////////////////////
//	var geometry	= new THREE.TorusKnotGeometry(0.3,0.1,64,16);
//	var material	= new THREE.MeshNormalMaterial(); 
//	var mesh	= new THREE.Mesh( geometry, material );
//  mesh.position.y	= 0.5
//	arWorldRoot.add( mesh );

	////////////////////////////////////////////////////////////////////////////////
	//          collada loader
	////////////////////////////////////////////////////////////////////////////////
//            var dae;
//            var loader = new THREE.ColladaLoader();
//            loader.options.convertUpAxis = true;
////            loader.load( 'data/protonSaga.dae', function ( collada ) {
//            loader.load( 'data/apdLogo.dae', function ( collada ) {
//                dae = collada.scene;
//
//                dae.traverse( function ( child ) {
//					if ( child instanceof THREE.SkinnedMesh ) {
//						var animation = new THREE.Animation( child, child.geometry.animation );
//						animation.play();
//					}
//				} );
//                
//                dae.scale.x = dae.scale.y = dae.scale.z = 0.5;
//                dae.updateMatrix();
//
////				scene.add( dae );
//                arWorldRoot.add(dae);
//
//            } );
//
//
//            onRenderFcts.push(function(){
//                //you can rotate the object, if you want...
//        		dae.rotation.y += 0.003
//            })
	//////////////////////////////////////////////////////////////////////////////////
	//		JSON loader
	//////////////////////////////////////////////////////////////////////////////////
            loader.load('./data/apdLogo0731.json', function (geometry, materials) {
//            loader.load('./data/json/eva-animated.json', function (geometry, materials) {
                materials.forEach(function (material) {
                  material.skinning = true;
                });
                character = new THREE.SkinnedMesh(
                  geometry,
                  new THREE.MeshFaceMaterial(materials)
                );

                mixer = new THREE.AnimationMixer(character);
                action = mixer.clipAction(geometry.animations[0]);
                action.setEffectiveWeight(1);
                action.enabled = true;
                character.scale.set( 0.5, 0.5, 0.5 );
                arWorldRoot.add(character);

//                window.addEventListener('resize', onWindowResize, false);
                animate();

//                isLoaded = true;

                action.play();

            });     
            
	//////////////////////////////////////////////////////////////////////////////////
	//		render the whole thing on the page
	//////////////////////////////////////////////////////////////////////////////////
        stats = new Stats();
        document.body.appendChild( stats.dom );

            // render the scene
//        onRenderFcts.push(function(){
//
//            renderer.render( scene, camera );
//            stats.update();
//        })

//        // run the rendering loop
//        var lastTimeMsec= null
//        requestAnimationFrame(function animate(nowMsec){
//            // keep looping
//            requestAnimationFrame( animate );
//            mixer.update(clock.getDelta());
//            // measure time
//            lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
//            var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
//            lastTimeMsec	= nowMsec
//            // call each update function
//            onRenderFcts.forEach(function(onRenderFct){
//                onRenderFct(deltaMsec/1000, nowMsec/1000)
//            })
//        })

            function animate () {
                //update AR elements
                arToolkitContext.update( arToolkitSource.domElement );
                smoothedControls.update(markerRoot);

                //update page
                stats.update();
                
                //update animation
                requestAnimationFrame(animate);
                mixer.update(clock.getDelta());

                render();
            }
//
            function render () {
              renderer.render(scene, camera);
            }

        </script>
    </body>
</html>
